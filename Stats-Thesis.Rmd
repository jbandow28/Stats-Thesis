---
title: "Thesis code"
author: "Jackson Bandow"
date: "2/5/2021"
output: html_document
---

Libraries necessary for project

```{r}
library(Lahman)
library(rvest)
library(dplyr)
library(readr)
library(httr)
library(data.table)
```


Import dataset

```{r}
data("Master")
data("Batting")
data("Pitching")
data("HallOfFame")
```

Compile seasonal stats to career dataset

```{r}
sum_vec <- function(vec) {
  data <- na.omit(vec)
  if (length(data) == 0) return(NA)
  else return(sum(data))
}

replace_na <- function(vec, rep) {
  res <- vec
  for (i in 1:length(vec)) {
    if (is.na(res[i])) res[i] <- rep
  }
  return(res)
}

# Batting
emp <- rep(NA, length(unique(Batting$playerID)))

batting_career <- data.frame(playerID = unique(Batting$playerID), firstyearID = emp, lastyearID = emp, G = emp, AB = emp, R = emp, H = emp, X2B = emp, X3B = emp, HR = emp, RBI = emp, SB = emp, CS = emp, BB = emp, SO = emp, IBB = emp, HBP = emp, SH = emp, SF = emp, GIDP = emp)

for (i in batting_career$playerID) {
  seasonal <- Batting[Batting$playerID == i,]
  batting_career[batting_career$playerID == i,-1] <- c(sort(seasonal$yearID)[1], tail(sort(seasonal$yearID), n=1), sum_vec(seasonal$G), sum_vec(seasonal$AB), sum_vec(seasonal$R), sum_vec(seasonal$H), sum_vec(seasonal$X2B), sum_vec(seasonal$X3B), sum_vec(seasonal$HR), sum_vec(seasonal$RBI), sum_vec(seasonal$SB), sum_vec(seasonal$CS), sum_vec(seasonal$BB), sum_vec(seasonal$SO), sum_vec(seasonal$IBB), sum_vec(seasonal$HBP), sum_vec(seasonal$SH), sum_vec(seasonal$SF), sum_vec(seasonal$GIDP))
}

# Pitching
emp <- rep(NA, length(unique(Pitching$playerID)))

pitching_career <- data.frame(playerID = unique(Pitching$playerID), firstyearID = emp, lastyearID = emp, W = emp, L = emp, G = emp, GS = emp, CG = emp, SHO = emp, SV = emp, IPout = emp, H = emp, ER = emp, HR = emp, BB = emp, SO = emp, BAOpp = emp, ERA = emp, IBB = emp, WP = emp, HBP = emp, BK = emp, BFP = emp, GF = emp, R = emp, SH = emp, SF = emp, GIDP = emp)

for (i in pitching_career$playerID) {
  seasonal <- Pitching[Pitching$playerID == i,]
  pitching_career[pitching_career$playerID == i,-1] <- c(sort(seasonal$yearID)[1], tail(sort(seasonal$yearID), n=1), sum_vec(seasonal$W), sum_vec(seasonal$L), sum_vec(seasonal$G), sum_vec(seasonal$GS), sum_vec(seasonal$CG), sum_vec(seasonal$SHO), sum_vec(seasonal$SV), sum_vec(seasonal$IPout), sum_vec(seasonal$H), sum_vec(seasonal$ER), sum_vec(seasonal$HR), sum_vec(seasonal$BB), sum_vec(seasonal$SO), NA, NA, sum_vec(seasonal$IBB), sum_vec(seasonal$WP), sum_vec(seasonal$HBP), sum_vec(seasonal$BK), sum_vec(seasonal$BFP), sum_vec(seasonal$GF), sum_vec(seasonal$R), sum_vec(seasonal$SH), sum_vec(seasonal$SF), sum_vec(seasonal$GIDP))
}
```


Attaching WAR

```{r}
# FanGraphs WAR

fan_pitch <- read.csv("FanGraphs Leaderboard (1)pitching.csv")[,c("playerid", "WAR")]
colnames(fan_pitch) <- c("fangraphsID", "fWAR_pitch")
fan_bat <- read.csv("FanGraphs Leaderboard (1).csv")[,c("playerid", "WAR")]
colnames(fan_bat) <- c("fangraphsID", "fWAR_bat")

# # Find duplicate names
# Master$Name <- paste(Master$nameFirst, Master$nameLast, sep = " ")
# names <- sort(Master$Name)
# dup <- NULL
# for (i in 1:length(names)) {
#   if (names[((i-1) %% length(names)) + 1] == names[((i-2) %% length(names)) + 1] | names[((i-1) %% length(names)) + 1] == names[(i %% length(names)) + 1]) {
#     dup <- append(dup, TRUE)
#   }
#   else {
#     dup <- append(dup, FALSE)
#   }
# }
# Master[order(Master$Name), "duplicate"] <- dup


fangraphs <- data.frame()
#fangraphs <- fangraphs[1:764,]
working <- TRUE
while(working) {
  print(i)
  stat <- status_code(GET(paste0("http://www.fangraphs.com/statss.aspx?playerid=", i)))
  if (stat != 500) {
    page <- read_html(paste0("http://www.fangraphs.com/statss.aspx?playerid=", i))
    name <- page %>% html_nodes("h1") %>% html_text()
    bday <- page %>% html_nodes(".player-info__bio-birthdate td") %>% html_text()
    if (length(name) == 0) working <- FALSE
    else fangraphs <- rbind(fangraphs, c(i, name, bday)) 
  }
  i <- i + 1
}
colnames(fangraphs) <- c("fangraphsID", "Name", "DOB")
fangraphs$DOB
fangraphs$birthMonth <- as.integer(gsub("/.*$?", "", fangraphs$DOB))
fangraphs$birthDay <- as.integer(gsub("/.*$?", "", gsub("^[0-9]*/?", "", fangraphs$DOB)))
fangraphs$birthYear <- as.integer(substr(gsub("^[0-9]*/?", "", gsub("^[0-9]*/?", "", fangraphs$DOB)), 1, 4))
fangraphs$birthDate <- as.Date(paste(fangraphs$birthYear, fangraphs$birthMonth, fangraphs$birthDay, sep = "-"))
fangraphs$Name <- trimws(fangraphs$Name)
fangraphs$fangraphsID <- as.integer(fangraphs$fangraphsID)
fangraphs <- fangraphs %>% dplyr::select(c("fangraphsID", "Name", "birthDate"))
fwrite(fangraphs, "fangraphsID.csv")

Master2 <- left_join(Master, fangraphs, by = c("Name", "birthDate"))
Master2 <- left_join(Master2, fan_pitch, by = "fangraphsID")
Master2 <- left_join(Master2, fan_bat, by = "fangraphsID")
Master2$fWAR <- ifelse(is.na(Master2$fWAR_bat) & is.na(Master2$fWAR_pitch), NA, ifelse(is.na(Master2$fWAR_bat), 0, Master2$fWAR_bat) + ifelse(is.na(Master2$fWAR_pitch), 0, Master2$fWAR_pitch))



# Baseball Reference WAR

Master2$rWAR <- NA
Master2$finalGame <- as.Date(Master2$finalGame)
get_rWAR <- function(row) {
  if (!is.na(row["bbrefID"]) & !is.na(row["finalGame"])) {
    page <- read_html(paste0("https://www.baseball-reference.com/players/", substr(row["bbrefID"], 1, 1), "/", row["bbrefID"], ".shtml"))
    modern_res <- page %>% html_nodes(".p1 div:nth-child(1) p+ p") %>% html_text()
    if (length(modern_res) > 0) return(as.numeric(modern_res))
    return(as.numeric(page %>% html_nodes(".p1 div:nth-child(1) p") %>% html_text()))
  }
  return(NA)
}

t <- 0
for (i in 9451:dim(Master2)[1]) {
  t <- t + 1/dim(Master2)[1]
  print(t)
  Master2$rWAR[i] <- get_rWAR(Master2[i,])
}
```


Plots 

```{r}
Master2_plots <- Master2 %>% dplyr::select("playerID", "fangraphsID", "bbrefID", "Name", "fWAR", "rWAR")
Master2_plots <- Master2_plots[complete.cases(Master2_plots),]
plot(x = Master2_plots$rWAR, y = Master2_plots$fWAR, pch = 16, main = "Baseball-Reference vs. FanGraphs WAR", xlab = "Baseball-Reference WAR", ylab = "FanGraphs WAR")
summary(lm(Master2_plots$rWAR ~ Master2_plots$fWAR))
```


Hall of Fame Data

```{r}
HallOfFame$percentVote <- HallOfFame$votes / HallOfFame$ballots
reg1_data <- data.frame()
for (i in unique(HallOfFame$playerID)) {
  temp <- HallOfFame %>% dplyr::filter(playerID == i)
  reg1_data <- rbind(reg1_data, c(i, max(na.omit(temp$percentVote))))
}
colnames(reg1_data) <- c("playerID", "percentVote")
reg1_data <- merge(reg1_data, Master2_plots, by = "playerID")
reg1_data <- reg1_data[complete.cases(reg1_data), ]
reg1_data$percentVote <- as.numeric(reg1_data$percentVote)
reg1_data <- reg1_data %>% dplyr::filter(reg1_data$percentVote != -Inf)
summary(lm(reg1_data$percentVote ~ reg1_data$fWAR))
summary(lm(reg1_data$percentVote ~ reg1_data$rWAR))
plot(reg1_data$percentVote, reg1_data$fWAR)
library(ggplot2)
library(plotly)
g <- ggplot(data = reg1_data, aes(x = rWAR, y = percentVote, text = Name)) + geom_point() + theme_bw()
ggplotly(g)
Master2_plots %>% dplyr::filter(rWAR >= 50) %>% ggplot(aes(x = rWAR)) + geom_histogram() + theme_bw()
Master2_plots %>% dplyr::filter(rWAR >= 50) %>% ggplot(aes(x = rWAR))
ggplotly(g2)
```


Compute other statistics

```{r}
# Batting

batting_career$AVG <- batting_career$H / batting_career$AB
batting_career$X1B <- batting_career$H - batting_career$X2B - batting_career$X3B - batting_career$HR
batting_career$SLG <- (batting_career$X1B + 2*batting_career$X2B + 3*batting_career$X3B + 4*batting_career$HR) / batting_career$AB
batting_career$PA <- batting_career$AB + batting_career$BB + replace_na(batting_career$HBP, 0) + replace_na(batting_career$SF, 0) + replace_na(batting_career$SH, 0) 
batting_career$OBP <- (batting_career$H + batting_career$BB + replace_na(batting_career$HBP, 0)) / (batting_career$PA - replace_na(batting_career$SH, 0))
batting_career$OPS <- batting_career$OBP + batting_career$SLG
batting_career$SBP <- batting_career$SB / (batting_career$SB + batting_career$CS)

```

